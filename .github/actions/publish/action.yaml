name: "Publish Artifact"
description: "Publish the artifact to GitHub Container Registry"

inputs:
  global-json-file:
    description: "The path to the global.json file"
    required: false
    default: "./global.json"
  bun-version-file:
    description: "The path to the .bun-version file"
    required: false
    default: ".bun-version"
  repository-owner:
    description: "The owner of the repository"
    required: false
    default: "${{ github.repository_owner }}"
  repository-name:
    description: "The name of the repository"
    required: false
    default: "${{ github.event.repository.name }}"
  operations-environment:
    description: "The operations environment to use for Aspire commands"
    required: false
    default: ${{ runner.os }}

runs:
  using: "composite"
  steps:
    - name: Setup .NET Core
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: ${{ inputs.global-json-file }}

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version-file: ${{ inputs.bun-version-file }}

    - name: Cache Aspire CLI
      id: cache-aspire
      uses: actions/cache@v5
      with:
        path: ~/.aspire
        key: ${{ inputs.operations-environment }}-aspire-cli
        restore-keys: |
          ${{ inputs.operations-environment }}-aspire-

    - name: Install Aspire CLI
      if: steps.cache-aspire.outputs.cache-hit != 'true'
      shell: bash
      run: curl -sSf https://aspire.dev/install.sh | bash -s -- -q dev

    - name: Add Aspire CLI to PATH
      shell: bash
      run: echo "$HOME/.aspire/bin" >> $GITHUB_PATH

    - name: Verify Aspire Installation
      shell: bash
      run: aspire --version

    - name: Push to GitHub Container Registry
      shell: bash
      run: aspire do push
      env:
        Parameters__container_endpoint: ghcr.io
        Parameters__container_repository: ${{ inputs.repository-owner }}/${{ inputs.repository-name }}

    - name: Install mcp-publisher
      shell: bash
      run: |
        curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher
      working-directory: ${{ github.workspace }}/src/Integrations/BookWorm.McpTools

    - name: Authenticate to MCP Registry
      shell: bash
      run: ./mcp-publisher login github-oidc
      working-directory: ${{ github.workspace }}/src/Integrations/BookWorm.McpTools

    - name: Set version in server.json
      if: github.ref_type == 'tag'
      shell: bash
      run: |
        VERSION=${GITHUB_REF#refs/tags/v}
        jq --arg v "$VERSION" '
          .version = $v |
          .packages[0].identifier |= gsub(":[^:]+$"; ":" + $v)
        ' server.json > server.tmp && mv server.tmp server.json
      working-directory: ${{ github.workspace }}/src/Integrations/BookWorm.McpTools

    - name: Publish server to MCP Registry
      if: github.ref_type == 'tag'
      shell: bash
      run: ./mcp-publisher publish
      working-directory: ${{ github.workspace }}/src/Integrations/BookWorm.McpTools
